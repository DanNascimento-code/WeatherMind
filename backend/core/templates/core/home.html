{% extends "base.html" %}

{% block title %}WeatherMind — Clima{% endblock %}

{% block content %}

<!-- ========================= -->
<!-- Search / Hero Section -->
<!-- ========================= -->
<section class="page-section">
    <div class="page-section-header">
        <div class="page-section-title">
            Consultar clima
        </div>
        <div class="page-section-subtitle">
            Busque uma cidade para visualizar dados climáticos atuais e históricos
        </div>
    </div>

    <div class="card">
        <form method="get">
            <div style="display: flex; gap: 1rem; align-items: center;">
                <input
                    type="text"
                    name="city"
                    placeholder="Digite o nome da cidade"
                    required
                >
                <button type="submit" class="btn-accent">
                    Buscar
                </button>
            </div>
        </form>
    </div>
</section>

<!-- ========================= -->
<!-- Current Weather Section -->
<!-- ========================= -->
{% if weather %}
<section class="page-section">
    <div class="page-section-header">
        <div class="page-section-title">
            Condições atuais
        </div>
        <div class="page-section-subtitle">
            Dados mais recentes para {{ weather.city }}
        </div>
    </div>

    <div class="card">
        <div style="display: flex; justify-content: space-between; gap: 2rem; align-items: center;">
            <div>
                <div class="card-title">
                    {{ weather.city }}
                </div>
                <div class="card-value">
                    {{ weather.temperature }}°C
                </div>
                <div class="text-secondary">
                    Sensação térmica: {{ weather.feels_like }}°C
                </div>
                <div class="text-secondary">
                    Umidade: {{ weather.humidity }}%
                </div>
            </div>

            {% if weather.condition %}
            <div class="text-secondary">
                {{ weather.condition }}
            </div>
            {% endif %}
        </div>
    </div>
</section>
{% endif %}

<!-- ========================= -->
<!-- Historical Chart Section -->
<!-- ========================= -->
{% if history %}
<section class="page-section">

    <div class="page-section-header">
        <div>
            <div class="page-section-title">
                Histórico de temperatura
            </div>
            <div class="page-section-subtitle">
                Variação recente ao longo do tempo
            </div>
        </div>

        <div class="weather-status-badge" id="weatherStatus"></div>
    </div>

    <div class="history-list">
        {% for record in history %}
            <div class="history-item">
                <div class="history-time">
                    {{ record.created_at|date:"d/m H:i" }}
                </div>

                <div class="history-temp">
                    {{ record.temperature }}°C
                </div>

                <div class="history-condition">
                    {{ record.condition }}
                </div>
            </div>
            {% endfor %}
        </ul>
    </div>

    <div class="chart-container" data-loading="true">
        <div class="chart-skeleton"></div>
        <canvas id="temperatureChart"></canvas>
    </div>

    
</section>
{% endif %}

{% endblock %}

{% block extra_js %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const labels = JSON.parse('{{ labels|safe }}');
    const temperatures = JSON.parse('{{ temperatures|safe }}');

    const COMFORT_MIN = 18;
    const COMFORT_MAX = 26;

    function temperatureColor(value) {
        if (value < COMFORT_MIN) {
            return 'rgba(56, 189, 248, 0.9)'; // cold - blue
        }
        if (value > COMFORT_MAX) {
            return 'rgba(251, 146, 60, 0.9)'; // hot - amber
        }
        return 'rgba(52, 211, 153, 0.9)'; // comfortable - green
    }

    function statusFromTemperatures(values) {
        const avg =
            values.reduce((a, b) => a + b, 0) / values.length;

        if (avg < COMFORT_MIN) {
            return { label: 'Frio', color: 'rgba(56,189,248,0.9)' };
        }

        if (avg > COMFORT_MAX) {
            return { label: 'Quente', color: 'rgba(251,146,60,0.9)' };
        }

        return { label: 'Confortável', color: 'rgba(52,211,153,0.9)' };
    }
    

    if (labels.length && temperatures.length) {
    const ctx = document.getElementById('temperatureChart');

    if (ctx) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Temperatura (°C)',
                    data: temperatures,

                    fill: true,
                    tension: 0.35,

                    borderWidth: 2,

                    /* Color each POINT based on temperature */
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    pointBackgroundColor: temperatures.map(t =>
                        temperatureColor(t)
                    ),

                    /* Color each LINE SEGMENT based on temperature */
                    segment: {
                        borderColor: ctx => {
                            const value = ctx.p1.parsed.y;
                            return temperatureColor(value);
                        }
                    },

                    /* Neutral fill so the line colors stand out */
                    backgroundColor: 'rgba(56, 189, 248, 0.12)',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,

                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.95)',
                        titleColor: '#e5e7eb',
                        bodyColor: '#e5e7eb',
                        borderColor: 'rgba(56, 189, 248, 0.4)',
                        borderWidth: 1,
                        padding: 10,
                        displayColors: false,
                        callbacks: {
                            label: ctx => ` ${ctx.parsed.y}°C`
                        }
                    }
                },

                scales: {
                    x: {
                        ticks: {
                            color: '#9ca3af'
                        },
                        grid: {
                            color: 'rgba(148, 163, 184, 0.08)',
                            drawBorder: false
                        }
                    },
                    y: {
                        ticks: {
                            color: '#9ca3af',
                            callback: value => `${value}°`
                        },
                        grid: {
                            color: 'rgba(148, 163, 184, 0.08)',
                            drawBorder: false
                        }
                    }
                }
            }
        });

        // remove skeleton
            document
                .querySelector('.chart-container')
                ?.setAttribute('data-loading', 'false');

            // status badge
            const status = statusFromTemperatures(temperatures);
            const badge = document.getElementById('weatherStatus');

            if (badge) {
                badge.textContent = status.label;
                badge.style.background = status.color;
                badge.style.color = '#0f172a';
            }    
        }
    }
</script>

{% endblock %}
